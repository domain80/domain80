---
import { Icon } from "astro-icon/components";

interface Props {
  title: string;
  url: string;
  slug: string;
}

const { title, url, slug } = Astro.props;
---

<div class="share-buttons flex items-center justify-between gap-4" data-slug={slug}>
  <!-- Like button -->
  <button
    id="like-button"
    class="like-btn flex items-center gap-2 text-zinc-600 dark:text-zinc-400 hover:text-red-500 dark:hover:text-red-400 transition-colors disabled:opacity-50"
    disabled
  >
    <Icon name="tabler:heart" class="like-icon w-5 h-5" />
    <Icon name="tabler:heart-filled" class="like-icon-filled w-5 h-5 hidden text-red-500" />
    <span class="like-count text-sm">--</span>
  </button>

  <!-- Share button -->
  <button
    id="share-button"
    class="flex items-center gap-2 text-zinc-600 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white transition-colors"
    data-title={title}
    data-url={url}
  >
    <Icon name="tabler:share" class="w-5 h-5" />
    <span class="text-sm share-text">Share</span>
  </button>
</div>

<script>
  import { supabase } from '../../lib/supabase';
  import { $auth, initAuth, getCachedLikes, setCachedLikes, updateCachedLikes } from '../../lib/stores';

  async function initShareButtons() {
    const container = document.querySelector('.share-buttons');
    const likeBtn = document.getElementById('like-button') as HTMLButtonElement;
    const likeCount = document.querySelector('.like-count');
    const likeIcon = document.querySelector('.like-icon');
    const likeIconFilled = document.querySelector('.like-icon-filled');
    const shareButton = document.getElementById('share-button');
    const shareText = document.querySelector('.share-text');

    if (!container || !likeBtn) return;

    const slug = container.getAttribute('data-slug');
    if (!slug) return;

    // Use shared auth store
    const authState = await initAuth();
    const userId = authState.user?.id;

    // Enable like button if logged in
    if (userId) {
      likeBtn.disabled = false;
    }

    function updateLikeUI(count: number, hasLiked: boolean) {
      if (likeCount) {
        likeCount.textContent = String(count);
      }
      if (hasLiked) {
        likeIcon?.classList.add('hidden');
        likeIconFilled?.classList.remove('hidden');
        likeBtn.classList.add('liked');
      } else {
        likeIcon?.classList.remove('hidden');
        likeIconFilled?.classList.add('hidden');
        likeBtn.classList.remove('liked');
      }
    }

    // Fetch like count and user's like status - combined query
    async function fetchLikeStatus(useCache = true) {
      // Check cache first
      if (useCache) {
        const cached = getCachedLikes(slug);
        if (cached) {
          updateLikeUI(cached.count, cached.hasLiked);
          return;
        }
      }

      // Combined query - get all likes for this post in one call
      const { data: likes, count } = await supabase
        .from('post_likes')
        .select('user_id', { count: 'exact' })
        .eq('post_slug', slug);

      const totalCount = count || 0;
      const hasLiked = userId ? (likes || []).some(like => like.user_id === userId) : false;

      // Update cache
      setCachedLikes(slug, totalCount, hasLiked);
      updateLikeUI(totalCount, hasLiked);
    }

    async function toggleLike() {
      if (!userId) {
        alert('Please sign in to like this post');
        return;
      }

      const isLiked = likeBtn.classList.contains('liked');

      // Optimistic update - update UI immediately
      const cachedLikes = getCachedLikes(slug);
      const currentCount = cachedLikes?.count || parseInt(likeCount?.textContent || '0');
      const newCount = isLiked ? currentCount - 1 : currentCount + 1;
      const newLikedState = !isLiked;

      updateLikeUI(newCount, newLikedState);
      updateCachedLikes(slug, newLikedState);

      // Send to server in background
      try {
        if (isLiked) {
          await supabase
            .from('post_likes')
            .delete()
            .eq('post_slug', slug)
            .eq('user_id', userId);
        } else {
          await supabase
            .from('post_likes')
            .insert({ post_slug: slug, user_id: userId });
        }
      } catch (error) {
        // Revert on error
        console.error('Like toggle failed:', error);
        updateLikeUI(currentCount, isLiked);
        updateCachedLikes(slug, isLiked);
      }
    }

    likeBtn.addEventListener('click', toggleLike);

    // Share button
    shareButton?.addEventListener('click', async () => {
      const title = shareButton.getAttribute('data-title') || '';
      const url = shareButton.getAttribute('data-url') || window.location.href;

      if (navigator.share) {
        try {
          await navigator.share({ title, url });
        } catch (err) {
          if ((err as Error).name !== 'AbortError') {
            console.error('Share failed:', err);
          }
        }
      } else {
        try {
          await navigator.clipboard.writeText(url);
          if (shareText) {
            const original = shareText.textContent;
            shareText.textContent = 'Copied!';
            setTimeout(() => {
              shareText.textContent = original;
            }, 2000);
          }
        } catch (err) {
          console.error('Copy failed:', err);
        }
      }
    });

    // Initial fetch (uses cache if available)
    await fetchLikeStatus();
  }

  // Initial load
  initShareButtons();

  // Handle Astro view transitions
  document.addEventListener('astro:after-swap', initShareButtons);
</script>

<style>
  .like-btn.liked {
    color: #ef4444;
  }

  .like-btn:not(:disabled):active {
    transform: scale(0.95);
  }
</style>
