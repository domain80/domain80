---
import { getCollection } from "astro:content";
import BlogCard from "../components/blog/BlogCard.astro";
import ProjectCard from "../components/portfolio/ProjectCard.astro";
import Badge from "../components/ui/Badge.astro";
import HomeLayout from "../layouts/HomeLayout.astro";
import { Icon } from "astro-icon/components";

// Get latest blog posts
const allPosts = await getCollection("blog");
const latestPosts = allPosts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3);

// Get featured projects
const allProjects = await getCollection("projects");

// Get personal projects
const personalProjects = allProjects
  .filter((p) => p.data.featured && p.data.type === 'personal')
  .sort((a, b) => (a.data.order || 999) - (b.data.order || 999))
  .slice(0, 3);

// Get work experience projects
const workProjects = allProjects
  .filter((p) => p.data.featured && p.data.type === 'work')
  .sort((a, b) => (a.data.order || 999) - (b.data.order || 999));
---

<HomeLayout title="Home">
  <!-- Latest Posts Section -->
  <section id="whats-on-my-mind" class="mb-16 mt-46 scroll-mt-60">
    <div class="flex items-center justify-between mb-6 scroll-mt-40">
      <h2 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">
        Latest Posts
      </h2>
      <a
        href="/blog"
        class="text-sm text-zinc-600 dark:text-zinc-400 hover:text-accent dark:hover:text-accent transition-colors"
      >
        View all →
      </a>
    </div>
    <div class="space-y-4">
      {
        latestPosts.map((post) => (
          <BlogCard
            title={post.data.title}
            description={post.data.description}
            slug={post.id}
          />
        ))
      }
    </div>
  </section>

  <!-- Projects Section -->
  <section id="projects" class="scroll-mt-48 mb-16">
    <h2 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100 mb-6">
      Projects
    </h2>
    <div class="space-y-8">
      {
        personalProjects.map((project) => (
          <ProjectCard
            title={project.data.title}
            description={project.data.description}
            year={project.data.year}
            endYear={project.data.endYear}
            tags={project.data.tags}
            link={project.data.link}
            linkText={project.data.linkText}
            slug={project.id}
            image={project.data.image}
          />
        ))
      }
    </div>
  </section>

  <!-- Experience Section -->
  <section id="experience" class="scroll-mt-48">
    <h2 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100 mb-6">
      Experience
    </h2>
    <div class="relative">
      <!-- Timeline vertical line -->
      <div class="absolute left-[7px] top-2 bottom-2 w-0.5 bg-zinc-200 dark:bg-zinc-700"></div>

      <div class="space-y-8">
        {
          workProjects.map((project, index) => {
            const yearRange = project.data.endYear
              ? `${project.data.year} - ${project.data.endYear}`
              : project.data.year;
            const isLast = index === workProjects.length - 1;

            return (
              <div class="relative pl-8">
                <!-- Timeline dot -->
                <div class="absolute left-0 top-1.5 w-4 h-4 rounded-full bg-accent border-4 border-white dark:border-zinc-900"></div>

                <!-- Content -->
                <article class="space-y-2">
                  <div>
                    <h3 class="text-lg font-bold text-zinc-900 dark:text-zinc-100">
                      {project.data.title}
                    </h3>
                    <span class="text-sm text-zinc-500 dark:text-zinc-400">{yearRange}</span>
                  </div>

                  <p class="text-zinc-700 dark:text-zinc-300 leading-relaxed">
                    {project.data.description}
                  </p>

                  <!-- Tech tags -->
                  <div class="flex flex-wrap gap-2">
                    {project.data.tags.map((tag) => <Badge variant="tech">{tag}</Badge>)}
                  </div>

                  {project.data.link && (
                    <a
                      href={project.data.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-1 text-sm text-accent hover:text-accent-dark transition-colors"
                    >
                      <span>{project.data.linkText || "View project →"}</span>
                      <Icon name="tabler:external-link" class="w-4 h-4" />
                    </a>
                  )}
                </article>
              </div>
            );
          })
        }
      </div>
    </div>
  </section>
</HomeLayout>
