---
// This page handles the OAuth callback from Supabase
// It exchanges the code for a session and redirects back
---

<html>
  <head>
    <meta charset="utf-8" />
    <title>Authenticating...</title>
  </head>
  <body>
    <p>Authenticating...</p>
    <script>
      import { supabase } from '../../lib/supabase';

      // Handle the OAuth callback
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const queryParams = new URLSearchParams(window.location.search);

      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');
      const code = queryParams.get('code');

      async function handleCallback() {
        if (code) {
          // Exchange code for session (PKCE flow)
          const { error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) {
            console.error('Auth error:', error);
          }
        } else if (accessToken && refreshToken) {
          // Implicit flow (legacy)
          const { error } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken,
          });
          if (error) {
            console.error('Auth error:', error);
          }
        }

        // Redirect back to the previous page or home
        const redirectTo = localStorage.getItem('auth_redirect') || '/';
        localStorage.removeItem('auth_redirect');
        window.location.href = redirectTo;
      }

      handleCallback();
    </script>
  </body>
</html>
